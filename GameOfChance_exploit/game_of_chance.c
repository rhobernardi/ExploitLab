/*******************************************
*		Game of Chance
*******************************************/


#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <time.h>
#include "error_check.h"

#define DATAFILE "/var/chance.data" // Arquivo para armazenar os dados do usuário

// Struct padrão de usuário para armazenar informação sobre usuários
struct user
{
	int uid;
	int credits;
	int highscore;
	char name[100];
	int (*current_game) ();
};

// Protótipos de função
int get_player_data();
void register_new_player();
void update_player_data();
void show_highscore();
void jackpot();
void input_name();
void print_cards(char *, char *, int);
int take_wager(int, int);
void play_the_game();
int pick_a_number();
int dealer_no_match();
int find_the_ace();
void fatal(char *);

// Variáveis glabais
struct user player;	//Struct do jogador

int main ()
{
	int choice, last_game;

	srand(time(0));	//Inicia randonmizador com a hora

	if (get_player_data() == -1)	// Tenta ler os dados do jogador a partir do arquivo
		register_new_player();	// Caso não haja dados, registra novo jogo
	
	while (choice != 7)
	{
		printf("-=[ Game of Chance Menu ]=-\n");
		printf("1 - Play the Pick a Number game\n");
		printf("2 - Play the No Match Dealer game\n");
		printf("3 - Play the Find the Ace game\n");
		printf("4 - View current high score\n");
		printf("5 - Change your user name\n");
		printf("6 - Reset your account at 100 credits\n");
		printf("7 - Quit\n");
		printf("[Name: %s]\n", player.name);
		printf("[You have %u credits] -> ", player.credits);
		scanf("%d", &choice);

		if ((choice < 1) || (choice > 7))
			printf("\n[!!] The number %d is an invalid selection.\n\n", choice);

		else if (choice < 4)	// Se não, a escolha foi um jogo de algum outro tipo
		{
			if (choice != last_game)	// Se a função ptr não foi definida
			{
				if (choice == 1)	// então aponta para o jogo selecionado
					player.current_game = pick_a_number;
				else if (choice == 2)
					player.current_game = dealer_no_match;
				else
					player.current_game = find_the_ace;

				last_game = choice;	// e define last_game
			}

			play_the_game();	// Jogar
		}

		else if (choice == 4)
			show_highscore;

		else if (choice == 5)
		{
			printf("\nChange user name\n");
			printf("Enter your new name: ");
			input_name();
			printf("Your name has been changed.\n\n");
		}

		else if (choice == 6)
		{
			player.credits = 100;
			printf("\nYour account has been reset with 100 credits.\n\n");
		}
	}

	update_player_data();
	printf("\nThanks for playing! Bye.\n");

	return 0;
}


// Esta Função lê os dados do jogador para o uid corrente
// do arquivo. Ela retorna -1 se não encontrar os dados do jogador
// para o uid atual.
int get_player_data()
{
	int fd, uid, read_bytes;
	struct user entry;

	uid = getuid();

	fd = open(DATAFILE, O_RDONLY);
	if (fd == -1)	// Não consegue abrir o arquivo, talvez ele não exista
		return -1;

	read_bytes = read(fd, &entry, sizeof(struct user));	// Lê o primeiro bloco

	while (entry.uid != uid && read_bytes > 0)	// Loop até encontrar o uid.
		read_bytes = read(fd, &entry, sizeof(struct user));	// Continua lendo

	close (fd);	// Fecha o arquivo

	if (read_bytes < sizeof(struct user))	// Se chegou ao fim do arquivo
		return -1;
	else player = entry;	// Copia a entrada lida para a struct do jogador

	return 1;	// Retorno bem sucedido
}


// Esta é a função para o registro de um novo usuário
// Isso criará uma nova conta de jogador e o cadastra no arquivo
void register_new_player()
{
	int fd;

	printf("-=-={ New Player Registration }=-=-\n");
	printf("Enter your name: ");
	input_name();

	player.uid = getuid();
	player.highscore = player.credits = 100;

	fd = open(DATAFILE, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);

	if (fd == -1)
		fatal("in register_new_player() while opening file");

	write(fd, &player, sizeof(struct user));
	close(fd);

	printf("\nWelcome to the Game of Chance, %s.\n", player.name);
	printf("You have been given %u credits\n", player.credits);
}


// Esta função grava os dados do jogador corrente no arquivo.
// A principio, ela é usada para atualizar os créditos após o jogo.
void update_player_data()
{
	int fd, i, read_uid;
	char burned_byte;

	fd = open(DATAFILE, O_RDWR);
	
	if (fd == -1)	// Se a abertura falhar aqui, algo errado ocorreu
		fatal("in update_player_data() while opening file");

	read(fd, &read_uid, 4);	// Lê o uid da primeira struct

	while (read_uid != player.uid)	// Loop ate que o uid correto seja encontrado.
	{
		for (i = 0; i < sizeof(struct user) - 4; ++i)	// Ler todo o resto da struct
			read(fd, &burned_byte, 1);

		read(fd, &read_uid, 4);	// Lê a struct do proximo uid
	}

	write(fd, &(player.credits), 4);	// Atualiza creditos.
	write(fd, &(player.highscore), 4);	// Atualiza o maior score.
	write(fd, &(player.name), 100);	// Atualiza o nome.

	close(fd);
}


// Esta função exibe o score atual mais alto e
// o nome da pessoa que alcançou essa pontuação.
void show_highscore()
{
	unsigned int top_score = 0;
	char top_name[100];
	struct user entry;
	int fd;

	printf("\n===============| HIGH SCORE |===============\n");
	fd = open(DATAFILE, O_RDONLY);

	if (fd == -1)
		fatal("in show_highscore() while opening file");

	while (read(fd, &entry, sizeof(struct user)) > 0)	// Loop até o fim do arquivo
	{
		if (entry.highscore > top_score)	// Se há um score mais alto,
		{
			top_score = entry.highscore;	// atribui este score para top_score
			strcpy(top_name, entry.name);	// e o nome ao top_name
		}
	}

	close(fd);

	if (top_score > player.highscore)
		printf("%s has the high score of %u\n", top_name, top_score);
	else
		printf("You currently have the high score of %u credits!\n", player.highscore);

	printf("============================================\n\n");
}


// Esta função atribui o grande premio para o jogo Pick a Number
void jackpot()
{
	printf("*+*+*+*+*+  JACKPOT  +*+*+*+*+*\n");
	printf("You have won the jackpot of 100 credits!\n");
	player.credits += 100;
}


// Esta função é usada para entrar com o nome do jogador, uma vez que
// scanf("%s", &whatever) sera interrompido assim que for informado uma barra de espaço
void input_name()
{
	char *name_ptr, input_char='\n';

	while (input_char == '\n')	// Enquanto não for digitado nada
		scanf("%c", &input_char);	// caracteres da nova linha

	name_ptr = (char *) &(player.name);	// name_ptr = endereço do nome do jogador

	while (input_char != '\n')	// Loop até a nova linha
	{
		*name_ptr = input_char;	// Coloca os caracteres de entrada no nome
		scanf("%c", &input_char);	// Incrementa o ponteiro do nome
		name_ptr++;	// Incrementa o ponteiro do nome
	}

	*name_ptr = 0;	// Conclui a string
}


// Esta função imprime as 3 cartas para o jogo Find the Ace
// Ela recebe uma mensagem para exibir um ponteiro para apontar, um array de cartas
// e carta que o usuario pegou. Se user_pick for -1,
// então os numeros selecionados serrão exibidos
void print_cards(char *message, char *cards, int user_pick)
{
	int i;

	printf("\n\t*** %s ***\n", message);
	printf("    \t._.\t._.\t._.\n");
	printf("Cards:\t|%c|\t|%c|\t|%c|\n\t", cards[0], cards[1], cards[2]);

	if (user_pick == -1)
		printf(" 1 \t 2 \t 3\n");
	else
	{
		for (i = 0; i < user_pick; ++i)
			printf("\t");

		printf(" ^-- your pick\n");
	}
}


// Esta função entra com apostasy para os jogos No Match Dealer e
// Find the Ace. Ela recebe os créditos disponiveis e a aposta
// anterior como argumento. O previous_wager é importante somente
// para a segunda aposta no jogo Find the Ace. A função
// retorna -1 se a aposta é muito alta ou muito baixa, e retorna
// a soma da aposta.
int take_wager(int available_credits, int previous_wager)
{
	int wager, total_wager;

	printf("How many of your %d credits would you like to wager? ", available_credits);
	scanf("%d", &wager);

	if (wager < 1)	// Certifica de que a aposta é maior que 0
	{
		printf("Nice try, but you must wager a positive number!\n");
		return -1;
	}

	total_wager = previous_wager + wager;

	if (total_wager > available_credits)	// Confirma os creditos disponiveis
	{
		printf("Your total wager of %d is more than you have!\n", total_wager);
		printf("You only have %d available credits, try again.\n", available_credits);
		return -1;
	}

	return wager;
}


// Esta função contem um loop que permite que o jogo atual seja
// jogado novamente. Ela tambem grava o total dos novos creditos no arquivo 
// após cada rodada.
void play_the_game()
{
	int play_again = 1;
	int (*game) ();
	char selection;

	while (play_again)
	{
		printf("\n[DEBUG] current_game pointer @ 0x%08x\n", player.current_game);

		if (player.current_game() != -1)	// Se o jogo segue sem erros e
		{
			if (player.credits > player.highscore)	// um novo record é definido,
				player.highscore = player.credits;	// atualiza o score ao arquivo

			printf("\nYou now have %u credits\n", player.credits);
			update_player_data();	// Grava o total do novo score ao arquivo
			
			printf("Would you like to play again? [y/n] ");
			selection = '\n';
			while (selection == '\n')	// Aguarda algum comando ser digitado
				scanf("%c", &selection);
			if (selection == 'n')
				play_again = 0;
		}

		else play_again = 0;	// Se o jogo retornou algum erro, retorna ao menu principal.
	}
}


// Esta função é o jogo Pick a Number.
// Ela retorna -1 se o jogador não possui créditos suficientes.
int pick_a_number()
{
	int pick, winning_number;

	printf("\n###### Pick a Number ######\n");
	printf("This game costs 10 credits to play. Simply pick a number\n");
	printf("between 1 and 20, and if you pick the winning number, you\n");
	printf("will win the jackpot of 100 credits!\n\n");

	winning_number = (rand() % 20) + 1;	// Escolhe um numero entre 1 e 20

	if (player.credits < 10)
	{
		printf("You only have %d credits. That's not enough to play!\n\n", player.credits);
		return -1;	// Sem creditos suficientes para jogar
	}

	player.credits -= 10;	// Reduz 10 creditos
	printf("10 credits have been deducted from your account.\n");
	printf("Pick a number between 1 and 20: \n");
	scanf("%d", &pick);

	printf("The winning number is %d\n", winning_number);
	if (pick == winning_number)
		jackpot();
	else printf("Sorry, you didn't win.\n");

	return 0;
}


// Este é o jogo No Match Dealer
// Ele retorna -1 se o jogador não possuir creditos.
int dealer_no_match()
{
	int i, j, numbers[16], wager = -1, match = -1;

	printf("\n::::::: No Match Dealer :::::::\n");
	printf("In this game, you can wager up to all of your credits.\n");
	printf("The dealer will deal out 16 random numbers between 0 and 99.\n");
	printf("If there are no matches among them, you double your money!\n\n");

	if (player.credits == 0)
	{
		printf("You don't have any credits to wager!\n\n");
		return -1;
	}

	while (wager == -1)
		wager = take_wager(player.credits, 0);

	printf("\t\t::: Dealing out 16 random numbers :::\n");
	for (i = 0; i < 16; ++i)
	{
		numbers[i] = rand() % 100;	// Escolhe um numero entre 0 e 99
		printf("%2d\t", numbers[i]);
		if (i%8 == 7)	// Imprime uma quebra de linha a cada 8 numeros.
			printf("\n");
	}

	for (i = 0; i < 15; ++i)	// Loop que procura por numeros compativeis
	{
		j = i + 1;

		while (j < 16)
		{
			if (numbers[i] == numbers[j])
				match = numbers[i];
			j++;
		}
	}

	if (match != -1)
	{
		printf("The dealer matched the number %d!\n", match);
		printf("You lose %d credits.\n", wager);
		player.credits -= wager;
	}

	else
	{
		printf("There were no matches! you win %d credits!\n", wager);
		player.credits += wager;
	}

	return 0;
}


// Este é o jogo Find the Ace.
// A função retorna -1 se o jogador não possuir creditos.
int find_the_ace()
{
	int i, ace, total_wager;
	int invalid_choice, pick = -1, wager_one = -1, wager_two = -1;
	char choice_two, cards[3] = {'X', 'X', 'X'};

	ace = rand() % 3;	// Place the Ace randomly

	printf("******* Find the Ace *******\n");
	printf("In this game, you can wager up to all of your credits.\n");
	printf("Three cards will be dealt out, two queens and one ace.\n");
	printf("If you find the ace, you will win you wager.\n");
	printf("After choosing a card, one of the queens will be revealed.\n");
	printf("At this point, you may either select a different card or\n");
	printf("incrase your wager\n");

	if (player.credits == 0)
	{
		printf("You don't have any credits to wager!\n\n");
		return -1;
	}

	while (wager_one == -1)	// Loop até que uma carta válida seja feita.
		wager_one = take_wager(player.credits, 0);

	print_cards("Dealing cards", cards, -1);
	pick = -1;
	while ((pick < 1) || (pick > 3))	// Loop até que uma carta valida seja retirada.
	{
		printf("Select a card: 1,2 or 3 ");
		scanf("%d", &pick);
	}

	pick --;	// Ajusta a retirada a partir de uma carta começada por 0
	i = 0;

	while (i == ace || i == pick)	// Manter loop até encontrar rainha valida para mostrar
		i++;

	cards[i] = 'Q';
	print_cards("Revealing a queen", cards, pick);
	invalid_choice = 1;

	while (invalid_choice)	// Loop até que uma escolha certa seja feita.
	{
		printf("Would you like to:\n[c]hange your pick\tor\t[i]ncrease your wager?\n");
		printf("Select c or i: ");
		choice_two = '\n';

		while (choice_two == '\n')	// Limpa linhas extras.
			scanf("%c", &choice_two);

		if (choice_two == 'i')	// Aumenta a aposta
		{
			invalid_choice = 0;	// Esta é uma escolha valida
			while (wager_two == -1)	// Loop até que a 2ª aposta valida seja feita.
				wager_two = take_wager(player.credits, wager_one);
		}

		if (choice_two == 'c')	// Troca a retirada
		{
			i = invalid_choice = 0;	// Escolha valida
			
			while (i == pick || cards[i] == 'Q')	// Loop até que outra carta
				i++;	// seja encontrada,

			pick = i;	// e então troca a retirada.
			printf("Your card pick has been changed to card %d\n", pick + 1);
		}
	}

	for (i = 0; i < 3; ++i)	// Revela todas as cartas.
	{
		if (ace == i)
			cards[i] = 'A';
		else
			cards[i] = 'Q';
	}

	print_cards("End result", cards, pick);

	if (pick == ace)	// Identifica uma vitoria
	{
		printf("You have won %d credits from yout first wager\n", wager_one);
		player.credits += wager_one;

		if (wager_two != -1)
		{
			printf("and an additional %d credits from your second wager!\n", wager_two);
			player.credits += wager_two;
		}
	}

	else 	// Handle loss
	{
		printf("You have lost %d credits from yout first wager\n", wager_one);
		player.credits -= wager_one;

		if (wager_two != -1)
		{
			printf("and an additional %d credits from your seccond wager!\n", wager_two);
			player.credits -= wager_two;
		}
	}

	return 0;
}
